<!DOCTYPE html>
<html>
<head>
    <title>AI Voice Assistant</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <div class="status-text">
                <div class="status-label" id="statusLabel">Connecting...</div>
                <div class="status-url" id="statusUrl"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Get WebSocket URL from query parameters
        const params = new URLSearchParams(window.location.search);
        const RELAY_SERVER_URL = params.get('wss');
        
        const statusDot = document.getElementById('statusDot');
        const statusLabel = document.getElementById('statusLabel');
        const statusUrl = document.getElementById('statusUrl');

        // Update status display
        function updateStatus(status, message) {
            statusDot.className = 'status-dot ' + status;
            statusLabel.textContent = message;
            statusUrl.textContent = RELAY_SERVER_URL || 'No server URL provided';
        }

        if (!RELAY_SERVER_URL) {
            updateStatus('disconnected', 'Error: Missing wss parameter');
        } else {
            connectToServer();
        }

        async function connectToServer() {
            try {
                updateStatus('connecting', 'Connecting to server...');
                
                // Connect to relay server
                const ws = new WebSocket(RELAY_SERVER_URL);
                
                ws.onopen = async () => {
                    console.log('Connected to relay server');
                    updateStatus('connected', 'Connected to AI');
                    
                    // Get microphone access
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const audioContext = new AudioContext({ sampleRate: 24000 });
                    const source = audioContext.createMediaStreamSource(stream);
                    
                    // Create audio processor
                    await audioContext.audioWorklet.addModule(createAudioProcessor());
                    const processor = new AudioWorkletNode(audioContext, 'audio-processor');
                    
                    // Connect audio pipeline
                    source.connect(processor);
                    
                    // Send audio to server
                    processor.port.onmessage = (event) => {
                        if (ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'input_audio_buffer.append',
                                audio: Array.from(event.data)
                            }));
                        }
                    };
                    
                    // Receive audio from server
                    ws.onmessage = async (event) => {
                        const message = JSON.parse(event.data);
                        
                        if (message.type === 'response.audio.delta' && message.delta) {
                            // Play audio response
                            playAudio(message.delta);
                        }
                    };
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateStatus('disconnected', 'Connection error');
                };
                
                ws.onclose = () => {
                    console.log('Disconnected from server');
                    updateStatus('disconnected', 'Disconnected');
                };
                
            } catch (error) {
                console.error('Error:', error);
                updateStatus('disconnected', 'Error: ' + error.message);
            }
        }

        // Audio playback
        const audioContext = new AudioContext({ sampleRate: 24000 });
        const audioQueue = [];
        let isPlaying = false;

        function playAudio(base64Audio) {
            const audioData = Uint8Array.from(atob(base64Audio), c => c.charCodeAt(0));
            audioQueue.push(audioData);
            
            if (!isPlaying) {
                processAudioQueue();
            }
        }

        async function processAudioQueue() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                return;
            }
            
            isPlaying = true;
            const audioData = audioQueue.shift();
            
            // Convert to audio buffer and play
            const audioBuffer = audioContext.createBuffer(1, audioData.length / 2, 24000);
            const channelData = audioBuffer.getChannelData(0);
            
            for (let i = 0; i < channelData.length; i++) {
                const int16 = (audioData[i * 2 + 1] << 8) | audioData[i * 2];
                channelData[i] = int16 / 32768.0;
            }
            
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.onended = processAudioQueue;
            source.start();
        }

        // Create audio processor worklet
        function createAudioProcessor() {
            const processorCode = `
                class AudioProcessor extends AudioWorkletProcessor {
                    process(inputs, outputs) {
                        const input = inputs[0];
                        if (input && input[0]) {
                            const samples = input[0];
                            const int16 = new Int16Array(samples.length);
                            for (let i = 0; i < samples.length; i++) {
                                int16[i] = Math.max(-32768, Math.min(32767, samples[i] * 32768));
                            }
                            this.port.postMessage(int16);
                        }
                        return true;
                    }
                }
                registerProcessor('audio-processor', AudioProcessor);
            `;
            
            const blob = new Blob([processorCode], { type: 'application/javascript' });
            return URL.createObjectURL(blob);
        }
    </script>
</body>
</html>